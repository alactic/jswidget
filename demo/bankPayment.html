<html>
<head>
    <title>BaseOne</title>
    <link rel="stylesheet" href="bankPayment.css">
    <link rel="stylesheet" href="paymentPlan.css">
    <link rel="stylesheet" href="bankTransfer.css">
    <link rel="stylesheet" href="transactionFeedback.css">
    <link rel="stylesheet" href="transaction-loading.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <script src="widget.js" type="application/javascript"></script>
    <script>
        var reference = "";
        var currency = "";
        var publicKey = "";
        var dataPayload = "";
        var clientAmount = 0;
        var cardAmount = 0;
        var transferAmount = 0;

        function configAmount(option) {
            console.log({option, clientAmount})
            let fee = 0;
            const value = option["flatRate"] + ((option["percentage"]*clientAmount)/100);
            if(value > option["pricingCap"]) {
                fee = option["pricingCap"]
            }else{
                fee = value
            }
            const totalAmount = clientAmount + fee;
            return totalAmount
        }

        function initializatonWidget(){
            document.getElementById( 'bank-payment-container-iitg33405-fgti594' ).style.display = 'none';
            document.getElementById( 'transfer-container-495gjjhg-gkhkhjg' ).style.display = 'flex';
        }

        async function initialise() {
            var url = new URL(window.location.href);
            var urlData = url.searchParams.get("data");
            dataPayload = JSON.parse(urlData);
            const {imageUrl, country} = dataPayload;
            publicKey = dataPayload.publicKey;
            clientAmount = dataPayload.amount;
            currency = dataPayload.currency;
            document.getElementById("logo").src= imageUrl;
            document.getElementById("logo2").src= imageUrl;
            document.getElementById("logo3").src= imageUrl;
            document.getElementById("logo4").src= imageUrl;
            document.getElementById("logo5").src= imageUrl;
            document.getElementById("logo6").src= imageUrl;
            document.getElementsByClassName("logo-icon")[0].src= imageUrl;

            
            fetch('https://afcollectionaggregatortest.azurewebsites.net/api/v1/widget/config', {
            method: 'POST',
            headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            "Api-Key": publicKey
            },
            body: JSON.stringify({currency, country})
            })
            .then(response => response.json())
            .then(res => {
            if(!res.requestSuccessful){
                document.getElementsByClassName("transaction-feedback-container-iitg33405-fgti594")[0].style.display="flex"
                document.getElementsByClassName("transaction-message-items")[0].style.display="none"
                document.getElementsByClassName("transaction-failed-message-items")[0].style.display="flex"
                document.getElementsByClassName("message-desc")[0].innerHTML=res.message;
            }else{
                const {Cards, Transfer} = res.responseData.priceingConfigs
                cardAmount = configAmount(Cards);
                transferAmount = configAmount(Transfer);
                console.log({cardAmount, transferAmount})
                dataPayload['initReference'] = res.responseData.reference;
                document.getElementById( 'transfer-container-495gjjhg-gkhkhjg' ).style.display = 'flex';
            }
            document.getElementsByClassName("transaction-loading-container-iitg33405-fgti594")[0].style.display="none"
           }).catch(error => {
               console.log({error});
           })            
                        
        }

        function pay(){
            const payload = {
                "cardNumber": document.getElementById("c_number").value,
                "cardPin": document.getElementById("c_pin").value,
                "cardCvv": document.getElementById("c_cvv").value,
                "cardExpiredYear": "20"+ document.getElementById("c_expiry").value.split('/')[1],
                "cardExpiredMonth": document.getElementById("c_expiry").value.split('/')[0]
            }
            console.log({payload})
            document.getElementsByClassName("loader")[0].style.display="inline-block"
            fetch('https://jsonplaceholder.typicode.com/todos/1')
            .then(response => response.json())
            .then(json => {
          var url = new URL(window.location.href);
            var c = url.searchParams.get("data");
            console.log(JSON.parse(c).token);
            
            document.getElementsByClassName("loader")[0].style.display="none"
           })      
        }

        function validateTransfer(type){
            let validateUrl = `https://afcollectionaggregatortest.azurewebsites.net/api/v1/widget/validate?transactionReference=${reference}`
            if(type === "card") {
                let cardPin = "";
                [1,2,3,4].forEach(val=>{
                    cardPin = cardPin + document.getElementById(`c_otp${val}`).value
                });
                validateUrl = validateUrl+ `&otp=${cardPin}`
            }
            document.getElementsByClassName("transaction-loading-container-iitg33405-fgti594")[0].style.display="flex";
            document.getElementsByClassName( 'transfer-container-495gjjhg-gkhkhjg' )[0].style.display = 'none';

            fetch(validateUrl, {
            method: 'POST',
            headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            "Api-Key": publicKey
            },
            body: null
            })
            .then(response => response.json())
            .then(res => {
                const status = res.responseData && res.responseData.transactionStatus
                if(!res.requestSuccessful || (status !== "Processing" && status !== "Success")){
                        document.getElementsByClassName("transaction-feedback-container-iitg33405-fgti594")[0].style.display="flex"
                        document.getElementsByClassName("transaction-message-items")[0].style.display="none"
                        document.getElementsByClassName("transaction-failed-message-items")[0].style.display="flex"
                        document.getElementsByClassName("message-desc")[0].innerHTML=res.message==="Successful"?"Failed":res.message;
                        const url = new URL(window.location.href);
                        document.getElementsByClassName("transaction-loading-container-iitg33405-fgti594")[0].style.display="none"

                    }else if(status !== "Processing" || (type === "card" && status === "Processing")){
                        document.getElementsByClassName("transaction-feedback-container-iitg33405-fgti594")[0].style.display="flex"
                        document.getElementsByClassName("transaction-message-items")[0].style.display="flex"
                        document.getElementsByClassName("transaction-failed-message-items")[0].style.display="none"
                        document.getElementsByClassName("amount")[0].innerHTML=res.message
                        document.getElementsByClassName("currency")[0].innerHTML=res.message
                        document.getElementById("bank-name").innerHTML=res.message
                        document.getElementById("account-number").innerHTML=res.message
                        document.getElementsByClassName("message-desc")[0].innerHTML=res.message;
                        const url = new URL(window.location.href);
                        // const successRes = url.searchParams.get("success");
                        // const onSuccess = eval("(" + successRes + ")");
                        // onSuccess()
                    document.getElementsByClassName("transaction-loading-container-iitg33405-fgti594")[0].style.display="none"
                }else{
                   setTimeout(() => validateTransfer(), 15000)
                }
            
           }).catch(error => {
               console.log({error});
           })
               
        }
        function initializeBankPayment(){
            document.getElementById( 'transfer-container-495gjjhg-gkhkhjg' ).style.display = 'none';
            document.getElementById( 'bank-payment-container-iitg33405-fgti594' ).style.display = 'flex';
            document.getElementById("card_pay").innerHTML = `Pay ${cardAmount} ${currency}`  

        }
        function bankTransaction(type){
            const payload =  {...dataPayload};
            let totalAmount = 0;
            payload["transactionMeta"] = {};
            delete payload['imageUrl']
            delete payload['publicKey']
            delete payload['url'];

            if(type === "card"){
                const chargeParameter = {
                "cardNumber": document.getElementById("c_number").value,
                "cardPin": document.getElementById("c_pin").value,
                "cardCvv": document.getElementById("c_cvv").value,
                "cardExpiredYear": "20"+ document.getElementById("c_expiry").value.split('/')[1],
                "cardExpiredMonth": document.getElementById("c_expiry").value.split('/')[0]
               }
                totalAmount = cardAmount
                payload["chargeParameter"] = chargeParameter;  
                }else {
                    totalAmount = transferAmount
                    payload["chargeParameter"] = {};    
                }
                

                document.getElementsByClassName("transaction-loading-container-iitg33405-fgti594")[0].style.display="flex";
                document.getElementsByClassName( 'transfer-container-495gjjhg-gkhkhjg' )[0].style.display = 'none';
                fetch(`https://afcollectionaggregatortest.azurewebsites.net/api/v1/widget/charge`, {
                method: 'POST',
                headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                "Api-Key": publicKey
                },
                body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(res => {
                const {BankName, AccountNumber, ProviderMessage, ExpiryTime} = res.responseData
                if(!res.requestSuccessful){
                    document.getElementsByClassName("transaction-feedback-container-iitg33405-fgti594")[0].style.display="flex"
                    document.getElementsByClassName("transaction-message-items")[0].style.display="none"
                    document.getElementsByClassName("transaction-failed-message-items")[0].style.display="flex"
                    document.getElementsByClassName("message-desc")[0].innerHTML=res.message
                }else{
                    reference = res.responseData.TransactionRefernce;
                    if(type === "card"){
                      document.getElementById( 'otp-container-iitg33405-fgti594' ).style.display = 'flex';
                    }else{
                        document.getElementsByClassName( 'bank-transfer-container-iitg33405-fgti594' )[0].style.display = 'flex';
                        document.getElementsByClassName("amount")[0].innerHTML=totalAmount
                    document.getElementsByClassName("currency")[0].innerHTML=currency
                    document.getElementsByClassName("amount")[1].innerHTML=totalAmount
                    document.getElementsByClassName("currency")[1].innerHTML=currency
                    document.getElementById("bank-name").innerHTML=BankName
                    document.getElementById("account-number").innerHTML=AccountNumber
                    document.getElementById("expiryTime").innerHTML=ExpiryTime
                    document.getElementsByClassName("message-desc")[0].innerHTML=res.message;
                    }                    
                }
            document.getElementsByClassName("transaction-loading-container-iitg33405-fgti594")[0].style.display="none"
           }).catch(error => {
               console.log({error});
           })
            // document.getElementById( 'transfer-container-495gjjhg-gkhkhjg' ).style.display = 'none';
            // document.getElementById( 'bank-transfer-iitg33405-fgti594' ).style.display = 'flex';
        }

        function c_format(event) {
            var code = (event.which) ? event.which : event.keyCode;
            if ((code < 48 || code > 57) && (code > 31)) {
                return false;
            }

            const value = document.getElementById("c_number").value;
            var v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '')
            var matches = v.match(/\d{4,16}/g);
            var match = matches && matches[0] || ''
            var parts = []

            for (i=0, len=match.length; i<len; i+=4) {
                parts.push(match.substring(i, i+4))
            }

            if (parts.length) {
                document.getElementById("c_number").value = parts.join(' ');
                return
            } else {
                return value
            }
        }
        
        function c_expires_format(event) {
            const value = document.getElementById("c_expiry").value;
            const cardExpiry = value.replace(
                /[^0-9]/g, '' // To allow only numbers
            ).replace(
                /^([2-9])$/g, '0$1' // To handle 3 > 03
            ).replace(
                /^(1{1})([3-9]{1})$/g, '0$1/$2' // 13 > 01/3
            ).replace(
                /^0{1,}/g, '0' // To handle 00 > 0
            ).replace(
                /^([0-1]{1}[0-9]{1})([0-9]{1,2}).*/g, '$1/$2' // To handle 113 > 11/3
            );
        }

        function c_cvv_format(){
            const value = document.getElementById("c_cvv").value;
            var v = value.replace(
                /[^0-9]/g, '' // To allow only numbers
            )
            document.getElementById("c_cvv").value = v;    
        }

        function c_pin_format(){
            const value = document.getElementById("c_pin").value;
            var v = value.replace(
                /[^0-9]/g, '' // To allow only numbers
            )
            document.getElementById("c_pin").value = v;    
        }

        function c_otp_format(type) {
            if(type < 4 && document.getElementById(`c_otp${type}`).value !=="") {
                document.getElementById(`c_otp${type+1}`).focus();
            }
        }

        function closeModal(){       
            closePaymentWidget();
        }
    </script>
</head>
<body class="content" onload="initialise()">
    <div id="transfer-container-495gjjhg-gkhkhjg" class="transfer-container-495gjjhg-gkhkhjg">
        <div class="transfer-content">
        <div class="transfer-header">
            <div class="transfer-header-icons">
                <img src="" onclick="closeModal()" id="logo" class="logo-icon" alt="icon"/>
                <img src="./assets/cancel-icon-white.png" onclick="closeModal()" class="cancel-icon" alt="icon"/>
            </div>
            <div class="transfer-header-text">How would you like to pay NGN 1000?</div>
        </div>
        <div class="transfer-options">
            <div class="transfer-option" onclick="initializeBankPayment()">
                <div class="option">
                    <div class="transfer-icon"><img src="./assets/card-icon.jpg" alt="icon"/></div>
                    <div>Card Payment</div>
                </div>
                <img src="./assets/arrow-right.jpg" alt="arrow"/>
            </div>
            <!-- <div class="transfer-option">
                <div class="option">
                    <div class="transfer-icon"><img src="./assets/ussd.jpg" alt="icon"/></div>
                    <div>USSD</div>
                </div>
                <img src="./assets/arrow-right.jpg" alt="arrow"/>
            </div> -->
            <div class="transfer-option" onclick="bankTransaction()">
                <div class="option">
                    <div class="transfer-icon"><img src="./assets/bank-icon.jpg" alt="icon"/></div>
                    <div>Bank Transfer</div>
                </div>
                <img src="./assets/arrow-right.jpg" alt="arrow"/>
            </div>
            <div class="secure-baseone">
                <img src="./assets/secure-icon.jpg" alt="icon"/>Secured by &nbsp;<b>Baseone</b>
            </div>
        </div>
     </div>
     </div>
    
            
    <div id="bank-payment-container-iitg33405-fgti594" class="bank-payment-container-iitg33405-fgti594">
        <div class="bank-payment-content">
        <div class="bank-payment-header">
            <img src="" onclick="closeModal()" id="logo6" class="logo-icon" alt="icon"/>
            <img src="./assets/cancel-icon.png" onclick="closeModal()" class="cancel-icon" alt="icon"/>
        </div>
       <div class="bank-payment-items">
        <div class="payment-title">Enter your card details</div>
        <div>
            <label>Card Number</label>
            <div>
                <input placeholder="0000 0000 0000 0000" id="c_number" onkeyup="return c_format(event)"/>
            </div>
        </div>
        <div class="d-flex">
            <div class="expiry">
                <label>Expiry Date</label>
                <div>
                    <input placeholder="MM / YY" id="c_expiry" onkeyup="c_expires_format(event)" maxlength=5/>
                </div>
            </div>
            <div class="cvv">
                <label>CVV</label>
                <div>
                    <input placeholder="123" id="c_cvv" onkeyup="c_cvv_format(event)" maxlength=3/>
                </div>
            </div>
        </div>
        <div>
                <label>Card Pin</label>
                <div>
                    <input placeholder="0000" id="c_pin" onkeyup="c_pin_format(event)" maxlength=4/>
                </div>
           </div>
        <div>
            <button class="pay-button" id="card_pay" onclick="bankTransaction('card')"><div class="loader"></div></button>
            <div class="change-payment" onclick="initializatonWidget()">Change Payment Method</div>
        </div>
       </div>
        </div>
    </div>

    <div id="otp-container-iitg33405-fgti594" class="bank-payment-container-iitg33405-fgti594">
        <div class="bank-payment-content">
        <div class="bank-payment-header">
            <img src="" onclick="closeModal()" id="logo5" class="logo-icon" alt="icon"/>
            <img src="./assets/cancel-icon.png" onclick="closeModal()" class="cancel-icon" alt="icon"/>
        </div>
       <div class="bank-payment-items">
        <div class="enter-otp">Enter OTP provided</div>
        <div class="otp-field-content">
            <div class="otp-field">
                <input type="password" maxlength=1  id="c_otp1" onkeyup="c_otp_format(1)"/>
            </div>
            <div class="otp-field">
                <input type="password" maxlength=1 id="c_otp2" onkeyup="return c_otp_format(2)"/>
            </div>
            <div class="otp-field">
                <input type="password" maxlength=1 id="c_otp3" onkeyup="return c_otp_format(3)"/>
            </div>
            <div class="otp-field">
                <input type="password" maxlength=1 id="c_otp4" onkeyup="return c_otp_format(4)"/>
            </div>
        </div>
        <div>
            <button class="pay-button" onclick="validateTransfer('card')">Proceed<div class="loader"></div></button>
            <div class="change-payment" onclick="closeModal()">Cancel Payment</div>
        </div>
       </div>
        </div>
    </div>

    <div id="bank-transfer-iitg33405-fgti594" class="bank-transfer-container-iitg33405-fgti594">
        <div class="bank-transfer-content">
        <div class="bank-transfer-header">
            <img src="" onclick="closeModal()" id="logo4" class="logo-icon" alt="icon"/>
            <img src="./assets/cancel-icon.png" onclick="closeModal()" class="cancel-icon" alt="icon"/>
        </div>
        <div class="payment-title">
            <div class="see-details">See details below</div>
            <div class="pay">Pay <span class="amount">4000</span><span class="currency">NGN</span></div>
        </div>
       <div class="bank-transfer-items">
        
        <div class="send-to">
            Send <b><span class="currency">NGN</span><span class="amount">4000</span></b> to <br/>Baseone checkout
        </div>
        <div class="transfer-info">
        <div id="bank-name">Wema Bank</div>
        <div id="account-number">760934590</div>
        <div class="desc">
            Use this account for this transaction only.</br/>
            Account expires in <b><span id="expiryTime">30</span> mins</b>
        </div>
        </div>
        <div>
            <button class="pay-button" onclick="validateTransfer()">I’ve sent the money</button>
         </div>
       </div>
        </div>
    </div>

    <div id="transaction-feedback-fgti594" class="transaction-loading-container-iitg33405-fgti594">
        <div class="transaction-feedback-content">
            <div class="bank-transfer-header">
                <img src="" onclick="closeModal()" id="logo2" class="logo-icon" alt="icon"/>
                <img src="./assets/cancel-icon.png" onclick="closeModal()" class="cancel-icon" alt="icon"/>
            </div>
            <div class="content">
                <div class="description">
                    <div class="content-loader"></div>
                    Please wait while your transaction 
                    is in progress..
                </div>
                <div class="secure-baseone">
                    <img src="./assets/secure-icon.jpg" alt="icon"/>Secured by &nbsp;<b>Baseone</b>
                </div>
            </div>
        </div>
        
    </div>

    <div id="transaction-message-fgti594" class="transaction-feedback-container-iitg33405-fgti594">
        <div class="transaction-feedback-content">
            <div class="bank-transfer-header">
                <img src="" onclick="closeModal()" id="logo3" class="logo-icon" alt="icon"/>
                <img src="./assets/cancel-icon.png" onclick="closeModal()" class="cancel-icon" alt="icon"/>
            </div>
            <div class="transaction-failed-message-items">
                <div class="message-icon">
                    <div class="message-icon-failed">
                        <img src="./assets/failed.png" alt="icon"/>
                    </div>
                </div>
                <div class="message-title">Transaction Failed</div>
                <div class="message-desc">Your transaction failed, please 
                    try again!</div>
                <div>
                    <button class="close-button" onclick="closeModal()">Close</button>
                </div>
            </div>
            <div class="transaction-message-items">
                <div class="message-icon">
                    <div class="message-icon-success">
                        <img src="./assets/success.png" alt="icon"/>
                    </div>
                </div>
                <div class="message-title">Successful</div>
                <div class="message-desc">Your payment was completed successfully</div>
                <div>
                    <button class="pay-button" onclick="closeModal()">Done</button>
                </div>
            </div>
       </div>
        </div>
    </div>

</body>
</html>